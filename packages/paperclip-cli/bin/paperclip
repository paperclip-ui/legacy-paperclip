#!/usr/bin/env node
const path = require("path");
const {init} = require("../lib/cli");
const {coverage} = require("../lib/coverage");
const {build} = require("paperclip-cli-minimal");
const fs = require("fs");
const  URL = require("url");
const {start: startWorkspace} = require("tandem-workspace/lib/server");

const argv = require("yargs")
.command("build", "Compiles paperclip files to target language", yargs => {
  yargs
  .option("watch", desc("watch for changes"))
  .option("print", desc("Only print compiled output"))
  .option("only", desc("Target files to generate"))
  .option("silent", desc("silence output information"))
  .option("output", desc("output directory of files"))
  .option("compiler", desc("Language compiler target (default is from paperclip.config.json if found)"))
}, argv => {
  build({
    cwd: process.cwd(),
    config: argv.config,
    print: argv.print,
    output: argv.output,
    css: argv.css,
    watch: argv.watch,
    definition: argv.definition,
    only: argv.only && argv.only.split(",").map(v => v.trim()),
    verbose: !argv.silent,
    dropPcExtension: argv.dropPcExtension,
    compilerName: argv.compiler,
    filePatterns: argv.filePattern
  })
})
.command("init", "Initialize new paperclip project", yargs => {
}, argv => {
  init();
})
.command("coverage", "Generate coverage report for PC files", yargs => {
  yargs
  .option("output", desc("output directory of files"))
}, argv => {
  coverage({
    output: argv.output,
    cwd: process.cwd()
  });
})
.command("designer", "Starts the designer server", yargs => {
  yargs
  .option("port", desc("HTTP port to listen on"))
  .option("canvasFile", desc("File to open initiall"))
  .default("open", true)
}, argv => {
  startWorkspace({
    http: {
      port: argv.port
    },
    canvasFile: argv.canvasFile && URL.pathToFileURL(path.join(process.cwd(), argv.canvasFile)),
    project: {
      installDependencies: false
    },
    standalone: true,
    showFullEditor: false
  }).then((workspace) => {
    workspace.start(process.cwd()).then(project => {
      project.openBrowser();
    });
  });
})
.argv;



function desc(description) {
  return {
    description
  }
}
